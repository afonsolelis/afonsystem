<%- include('../layout-head', { title: project.name }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2><%= project.name %></h2>
    <p class="text-muted mb-0"><%= project.path_with_namespace %></p>
    <% if (project.description) { %><p class="mt-1"><%= project.description %></p><% } %>
  </div>
  <div>
    <a href="<%= project.web_url %>" target="_blank" class="btn btn-outline-dark"><i class="bi bi-box-arrow-up-right"></i> GitLab</a>
    <a href="/" class="btn btn-outline-secondary ms-2">Voltar</a>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3><%= members.length %></h3>
        <p class="text-muted mb-0">Membros</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3><%= commits.length %></h3>
        <p class="text-muted mb-0">Commits</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3><%= mergeRequests.length %></h3>
        <p class="text-muted mb-0">Merge Requests</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h3><%= issues.length %></h3>
        <p class="text-muted mb-0">Issues</p>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Commits por Autor</div>
      <div class="card-body chart-container">
        <canvas id="chartCommitsByAuthor"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-header">MR Status</div>
      <div class="card-body chart-container">
        <canvas id="chartMRStatus"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-header">Issue Status</div>
      <div class="card-body chart-container">
        <canvas id="chartIssueStatus"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header">Membros</div>
      <div class="card-body">
        <table class="table table-hover">
          <thead><tr><th>Nome</th><th>Username</th><th>Nivel</th><th></th></tr></thead>
          <tbody>
            <% members.forEach(function(m) { %>
            <tr>
              <td><%= m.name %></td>
              <td><%= m.username %></td>
              <td><%= m.access_level %></td>
              <td><a href="/members/<%= m.username %>" class="btn btn-sm btn-outline-primary">Ver</a></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header">Commits</div>
      <div class="card-body">
        <table class="table table-hover">
          <thead><tr><th>ID</th><th>Autor</th><th>Data</th><th>Mensagem</th><th>+/-</th></tr></thead>
          <tbody>
            <% commits.forEach(function(c) { %>
            <tr>
              <td><code><%= c.short_id %></code></td>
              <td><%= c.author_name %></td>
              <td><%= c.committed_date ? c.committed_date.substring(0, 10) : '' %></td>
              <td><%= c.message.substring(0, 80) %></td>
              <td>
                <span class="badge badge-additions">+<%= c.additions %></span>
                <span class="badge badge-deletions">-<%= c.deletions %></span>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<% if (mergeRequests.length > 0) { %>
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header">Merge Requests</div>
      <div class="card-body">
        <table class="table table-hover">
          <thead><tr><th>#</th><th>Titulo</th><th>Autor</th><th>Status</th><th>Criado</th><th>Mergeado</th></tr></thead>
          <tbody>
            <% mergeRequests.forEach(function(mr) { %>
            <tr>
              <td>!<%= mr.iid %></td>
              <td><%= mr.title %></td>
              <td><%= mr.author_name %></td>
              <td><span class="badge bg-<%= mr.state === 'merged' ? 'success' : mr.state === 'opened' ? 'primary' : 'secondary' %>"><%= mr.state %></span></td>
              <td><%= mr.created_at ? mr.created_at.substring(0, 10) : '' %></td>
              <td><%= mr.merged_at ? mr.merged_at.substring(0, 10) : '-' %></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<% } %>

<% if (issues.length > 0) { %>
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header">Issues</div>
      <div class="card-body">
        <table class="table table-hover">
          <thead><tr><th>#</th><th>Titulo</th><th>Autor</th><th>Status</th><th>Labels</th><th>Criado</th><th>Fechado</th></tr></thead>
          <tbody>
            <% issues.forEach(function(i) { %>
            <tr>
              <td>#<%= i.iid %></td>
              <td><%= i.title %></td>
              <td><%= i.author_name %></td>
              <td><span class="badge bg-<%= i.state === 'opened' ? 'primary' : 'success' %>"><%= i.state %></span></td>
              <td><% (i.labels || []).forEach(function(l) { %><span class="badge bg-secondary me-1"><%= l %></span><% }) %></td>
              <td><%= i.created_at ? i.created_at.substring(0, 10) : '' %></td>
              <td><%= i.closed_at ? i.closed_at.substring(0, 10) : '-' %></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<% } %>

<script>
  var commitsByAuthor = <%- JSON.stringify(commitsByAuthor) %>;
  var mrStatusCounts = <%- JSON.stringify(mrStatusCounts) %>;
  var issueStatusCounts = <%- JSON.stringify(issueStatusCounts) %>;

  document.addEventListener('DOMContentLoaded', function() {
    var authors = Object.keys(commitsByAuthor);
    if (authors.length > 0) {
      renderInlineChart('chartCommitsByAuthor', 'bar', {
        labels: authors,
        datasets: [{ label: 'Commits', data: authors.map(function(a) { return commitsByAuthor[a].count; }) }]
      });
    }

    var mrLabels = Object.keys(mrStatusCounts);
    var mrColors = { opened: '#0d6efd', merged: '#198754', closed: '#dc3545' };
    if (mrLabels.some(function(l) { return mrStatusCounts[l] > 0; })) {
      renderInlineChart('chartMRStatus', 'doughnut', {
        labels: mrLabels,
        datasets: [{ data: mrLabels.map(function(l) { return mrStatusCounts[l]; }), backgroundColor: mrLabels.map(function(l) { return mrColors[l] || '#6c757d'; }) }]
      });
    }

    var issueLabels = Object.keys(issueStatusCounts);
    var issueColors = { opened: '#0d6efd', closed: '#198754' };
    if (issueLabels.some(function(l) { return issueStatusCounts[l] > 0; })) {
      renderInlineChart('chartIssueStatus', 'doughnut', {
        labels: issueLabels,
        datasets: [{ data: issueLabels.map(function(l) { return issueStatusCounts[l]; }), backgroundColor: issueLabels.map(function(l) { return issueColors[l] || '#6c757d'; }) }]
      });
    }
  });
</script>

<%- include('../layout-foot') %>
